# geminicli2api 快速部署指南

本指南将帮助您在10分钟内完成 geminicli2api 的本地部署。

## 📋 前置检查

在开始之前，请确认以下条件：

- [ ] 已安装 Docker Desktop（Windows/Mac）或 Docker Engine（Linux）
- [ ] Docker 正在运行中
- [ ] 已获取 Google OAuth 凭证（如未获取，参考 `Google_OAuth凭证获取教程.md`）
- [ ] 8888端口未被占用

验证Docker：
```bash
docker --version
docker-compose --version
```

## 🚀 快速部署（3步）

### 步骤1：配置环境变量

1. **复制示例配置**
   ```bash
   cd 202510201435_测试geminicli反向代理
   copy .env.example .env
   ```

2. **编辑 .env 文件**
   
   用文本编辑器打开 `.env`，填入以下信息：

   ```env
   # API访问密码（自己设置一个强密码）
   GEMINI_AUTH_PASSWORD=your_strong_password_123
   
   # 服务端口
   PORT=8888
   
   # Google OAuth凭证（JSON字符串）
   GEMINI_CREDENTIALS='{"client_id":"your-client-id","client_secret":"your-client-secret","token":"your-access-token","refresh_token":"your-refresh-token","scopes":["https://www.googleapis.com/auth/cloud-platform"],"token_uri":"https://oauth2.googleapis.com/token","project_id":"your-project-id"}'
   ```

   **重要**：
   - 将上面的 `your_strong_password_123` 替换为您自己的密码
   - 将 `GEMINI_CREDENTIALS` 的值替换为您的完整OAuth凭证JSON
   - 确保JSON字符串用单引号包裹

### 步骤2：启动服务

```bash
docker-compose up -d
```

等待约30秒，Docker会自动：
- 构建镜像
- 创建容器
- 启动服务

### 步骤3：验证部署

```bash
curl http://localhost:8888/health
```

**预期响应**：
```json
{"status":"healthy","service":"geminicli2api"}
```

如果看到这个响应，恭喜！部署成功！🎉

---

## 🧪 快速测试

### 测试1：列出可用模型

```bash
curl -X GET http://localhost:8888/v1/models ^
  -H "Authorization: Bearer your_strong_password_123"
```

应该看到一长串模型列表。

### 测试2：简单对话

```bash
curl -X POST http://localhost:8888/v1/chat/completions ^
  -H "Authorization: Bearer your_strong_password_123" ^
  -H "Content-Type: application/json" ^
  -d "{\"model\":\"gemini-2.5-flash\",\"messages\":[{\"role\":\"user\",\"content\":\"你好\"}]}"
```

应该收到Gemini的回复。

### 测试3：使用Python（推荐）

创建测试文件 `test_quick.py`：

```python
import openai

client = openai.OpenAI(
    base_url="http://localhost:8888/v1",
    api_key="your_strong_password_123"  # 替换为你的密码
)

response = client.chat.completions.create(
    model="gemini-2.5-flash",
    messages=[
        {"role": "user", "content": "用一句话介绍人工智能"}
    ]
)

print(response.choices[0].message.content)
```

运行：
```bash
python test_quick.py
```

---

## 📊 运维命令

### 查看服务状态
```bash
docker-compose ps
```

### 查看日志
```bash
# 查看所有日志
docker-compose logs

# 实时跟踪日志
docker-compose logs -f

# 查看最近100行
docker-compose logs --tail=100
```

### 停止服务
```bash
docker-compose stop
```

### 重启服务
```bash
docker-compose restart
```

### 完全停止并删除容器
```bash
docker-compose down
```

### 重新构建并启动
```bash
docker-compose up -d --build
```

---

## 🔧 常见问题快速解决

### Q1: 端口被占用

**现象**：
```
Error: bind: address already in use
```

**解决方案**：

方法1：修改端口
```bash
# 编辑 .env 文件
PORT=8889  # 改为其他端口
```

方法2：查找并关闭占用进程
```bash
# Windows
netstat -ano | findstr :8888
taskkill /PID <进程ID> /F

# Linux/Mac
lsof -ti:8888 | xargs kill -9
```

### Q2: Docker未启动

**现象**：
```
Cannot connect to the Docker daemon
```

**解决方案**：
- 启动 Docker Desktop
- 等待Docker完全启动（托盘图标正常）
- 重试部署命令

### Q3: 凭证无效

**现象**：
```
Authentication failed
```

**解决方案**：
1. 检查 `.env` 文件中的凭证格式
2. 确保JSON格式正确（使用在线JSON验证器）
3. 重新获取OAuth凭证
4. 查看容器日志：`docker-compose logs`

### Q4: 无法访问API

**现象**：
```
Connection refused
```

**解决方案**：
1. 确认服务正在运行：`docker-compose ps`
2. 检查健康端点：`curl http://localhost:8888/health`
3. 查看日志排查错误：`docker-compose logs`

---

## 🎯 下一步

部署成功后，您可以：

1. **运行完整测试**
   ```bash
   cd src
   python test_openai_api.py
   python test_gemini_api.py
   ```

2. **阅读详细文档**
   - 📘 [项目规划](项目规划.md) - 完整技术分析
   - 📘 [OAuth教程](Google_OAuth凭证获取教程.md) - 凭证管理
   - 📘 [故障排查](故障排查指南.md) - 问题解决

3. **集成到您的项目**
   - 将 `base_url` 设置为 `http://localhost:8888/v1`
   - 使用您的密码作为 `api_key`
   - 使用任何支持OpenAI API的客户端库

---

## 💡 最佳实践

### 安全建议
- ✅ 使用强密码（至少16位，包含大小写字母、数字、特殊字符）
- ✅ 定期轮换OAuth凭证
- ✅ 不要在公开场合分享 `.env` 文件
- ✅ 生产环境使用HTTPS

### 性能优化
- ✅ 使用 `gemini-2.5-flash` 获得更快响应
- ✅ 启用流式输出减少等待时间
- ✅ 合理设置 `max_tokens` 参数
- ✅ 使用连接池复用TCP连接

### 监控建议
- ✅ 定期检查服务健康：`curl http://localhost:8888/health`
- ✅ 监控日志文件大小，定期清理
- ✅ 设置资源限制，防止内存溢出

---

## 📞 获取帮助

如果遇到本指南未涵盖的问题：

1. 查看 [故障排查指南](故障排查指南.md)
2. 查看项目日志：`docker-compose logs`
3. 访问原项目 Issues：https://github.com/gzzhongqi/geminicli2api/issues
4. 参考本地的 [项目规划.md](项目规划.md) 文档

---

**文档版本**: 1.0  
**创建时间**: 2025-10-20  
**预计部署时间**: 10分钟

祝您部署顺利！🚀

