# geminicli2api 项目规划文档

## 项目概述

**项目名称**: geminicli2api  
**项目来源**: https://github.com/gzzhongqi/geminicli2api  
**项目目标**: 研究并部署基于FastAPI的Gemini API代理服务，实现将Google Gemini CLI工具转换为标准API接口

## 一、项目价值分析

### 1.1 核心价值
- ✅ **免费使用Gemini模型**: 利用Google的免费Gemini API配额
- ✅ **OpenAI兼容接口**: 使用熟悉的OpenAI API格式，降低迁移成本
- ✅ **双重API支持**: 同时提供OpenAI兼容和原生Gemini两种API接口
- ✅ **流式输出**: 支持实时流式响应
- ✅ **多模态支持**: 支持文本和图像输入
- ✅ **思维过程控制**: 可控制Gemini的推理过程（maxthinking/nothinking模式）

### 1.2 应用场景
- 开发环境中快速测试Gemini模型
- 将现有OpenAI API调用迁移到Gemini
- 搭建私有AI服务API网关
- 学习和研究Gemini API的使用方式

## 二、技术架构分析

### 2.1 项目结构
```
geminicli2api/
├── app.py                  # 主入口文件（Hugging Face兼容）
├── run.py                  # 备用运行脚本
├── requirements.txt        # Python依赖包
├── Dockerfile             # Docker镜像构建文件
├── docker-compose.yml     # Docker Compose配置
├── src/                   # 源代码目录
│   ├── main.py           # FastAPI应用主文件
│   ├── config.py         # 配置常量（模型列表、端点等）
│   ├── auth.py           # OAuth认证和用户鉴权
│   ├── models.py         # 数据模型定义
│   ├── utils.py          # 工具函数
│   ├── openai_routes.py  # OpenAI兼容路由
│   ├── openai_transformers.py  # OpenAI格式转换器
│   ├── gemini_routes.py  # 原生Gemini路由
│   └── google_api_client.py    # Google API客户端
```

### 2.2 核心技术栈
- **Web框架**: FastAPI + Uvicorn
- **认证系统**: Google OAuth 2.0
- **API代理**: requests库
- **容器化**: Docker + Docker Compose
- **Python版本**: 3.11

### 2.3 关键模块功能

#### A. 认证模块 (auth.py)
- Google OAuth 2.0 流程
- 多种认证方式支持：
  - Bearer Token
  - Basic Auth
  - Query Parameter (key参数)
  - Google Header (x-goog-api-key)
- 凭证管理和自动刷新
- 用户onboarding流程

#### B. 路由模块
**OpenAI兼容路由 (openai_routes.py)**:
- POST /v1/chat/completions - 聊天补全
- GET /v1/models - 列出可用模型

**Gemini原生路由 (gemini_routes.py)**:
- GET /v1beta/models - 列出Gemini模型
- POST /v1beta/models/{model}:generateContent - 生成内容
- POST /v1beta/models/{model}:streamGenerateContent - 流式生成
- 所有其他Gemini API端点代理

#### C. 配置模块 (config.py)
- 支持模型列表（Gemini 2.5 Pro/Flash系列）
- 模型变体生成：
  - `-search`: 启用Google搜索
  - `-nothinking`: 最小化推理
  - `-maxthinking`: 最大化推理预算
- 安全设置和默认参数

## 三、环境变量配置

### 3.1 必需环境变量
| 变量名 | 说明 | 示例 |
|--------|------|------|
| `GEMINI_AUTH_PASSWORD` | API访问密码 | `your_secure_password` |

### 3.2 凭证来源（四选一）
| 变量名 | 说明 | 优先级 |
|--------|------|--------|
| `GEMINI_CREDENTIALS` | JSON字符串形式的Google OAuth凭证 | 1 |
| `GOOGLE_APPLICATION_CREDENTIALS` | Google OAuth凭证文件路径 | 2 |
| `GOOGLE_CLOUD_PROJECT` | Google Cloud项目ID | 3 |
| `GEMINI_PROJECT_ID` | 备用项目ID变量 | 4 |

### 3.3 凭证JSON格式
```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "token": "your-access-token",
  "refresh_token": "your-refresh-token",
  "scopes": ["https://www.googleapis.com/auth/cloud-platform"],
  "token_uri": "https://oauth2.googleapis.com/token"
}
```

## 四、部署方案

### 4.1 本地Docker部署（推荐）

#### 步骤1：准备环境文件
创建 `.env` 文件：
```bash
GEMINI_AUTH_PASSWORD=your_password_here
PORT=8888
GEMINI_CREDENTIALS='{"client_id":"...","refresh_token":"..."}'
```

#### 步骤2：构建并运行
```bash
# 构建镜像
docker build -t geminicli2api .

# 运行容器（8888端口）
docker run -p 8888:8888 --env-file .env geminicli2api

# 或使用Docker Compose
docker-compose up -d
```

### 4.2 Hugging Face Spaces部署
1. Fork项目到个人GitHub
2. 在Hugging Face创建新的Space
3. 连接GitHub仓库
4. 配置环境变量（Secrets）
5. 自动构建和部署

### 4.3 本地Python环境部署
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 运行服务
python app.py
```

## 五、Google OAuth凭证获取流程

### 5.1 前置条件
- 拥有Google账号
- 可访问Google Cloud Console

### 5.2 详细步骤

#### 步骤1：创建Google Cloud项目
1. 访问 https://console.cloud.google.com/
2. 点击 "选择项目" → "新建项目"
3. 输入项目名称，点击"创建"
4. 记录项目ID

#### 步骤2：启用必要的API
1. 在项目中搜索并启用以下API：
   - Cloud AI Platform API
   - Gemini API
   - OAuth2 API

#### 步骤3：创建OAuth 2.0凭证
1. 导航到 "API和服务" → "凭据"
2. 点击 "创建凭据" → "OAuth 2.0 客户端ID"
3. 应用类型选择 "桌面应用"
4. 输入名称，点击"创建"
5. 下载凭证JSON文件

#### 步骤4：获取Refresh Token
##### 方法A：使用项目自带的OAuth流程
1. 首次启动服务时会自动打开浏览器
2. 登录Google账号并授权
3. 凭证自动保存到 `oauth_creds.json`

##### 方法B：使用Google OAuth Playground
1. 访问 https://developers.google.com/oauthplayground/
2. 在Settings中输入你的Client ID和Client Secret
3. 选择所需的scope：`https://www.googleapis.com/auth/cloud-platform`
4. 完成授权流程获取refresh_token

### 5.3 凭证配置示例
```json
{
  "client_id": "681255809395-xxx.apps.googleusercontent.com",
  "client_secret": "GOCSPX-xxxxxxxxxxxxx",
  "token": "ya29.a0AfH6SMBxxx...",
  "refresh_token": "1//0gxxxxxxxxxxx",
  "scopes": ["https://www.googleapis.com/auth/cloud-platform"],
  "token_uri": "https://oauth2.googleapis.com/token",
  "project_id": "your-project-id"
}
```

## 六、API使用示例

### 6.1 OpenAI兼容接口

#### Python示例（使用OpenAI库）
```python
import openai

client = openai.OpenAI(
    base_url="http://localhost:8888/v1",
    api_key="your_password"
)

# 非流式调用
response = client.chat.completions.create(
    model="gemini-2.5-pro",
    messages=[
        {"role": "user", "content": "什么是量子计算？"}
    ]
)
print(response.choices[0].message.content)

# 流式调用
stream = client.chat.completions.create(
    model="gemini-2.5-flash",
    messages=[
        {"role": "user", "content": "解释相对论"}
    ],
    stream=True
)

for chunk in stream:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="")
```

#### 带思维过程的调用
```python
# 最大化推理
response = client.chat.completions.create(
    model="gemini-2.5-pro-maxthinking",
    messages=[
        {"role": "user", "content": "解决这个数学问题：..."}
    ],
    stream=True
)

for chunk in response:
    # 推理过程
    if chunk.choices[0].delta.reasoning_content:
        print(f"[思考]: {chunk.choices[0].delta.reasoning_content}")
    # 最终答案
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="")
```

### 6.2 原生Gemini接口

#### Python + requests示例
```python
import requests

url = "http://localhost:8888/v1beta/models/gemini-2.5-pro:generateContent"
headers = {
    "Authorization": "Bearer your_password",
    "Content-Type": "application/json"
}
data = {
    "contents": [
        {
            "role": "user",
            "parts": [{"text": "解释机器学习"}]
        }
    ]
}

response = requests.post(url, headers=headers, json=data)
print(response.json())
```

#### 带Google搜索的调用
```python
url = "http://localhost:8888/v1beta/models/gemini-2.5-pro-search:generateContent"
# 其他配置相同
```

### 6.3 curl命令示例
```bash
# OpenAI兼容接口
curl -X POST http://localhost:8888/v1/chat/completions \
  -H "Authorization: Bearer your_password" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.5-flash",
    "messages": [{"role": "user", "content": "你好"}]
  }'

# Gemini原生接口
curl -X POST http://localhost:8888/v1beta/models/gemini-2.5-pro:generateContent \
  -H "Authorization: Bearer your_password" \
  -H "Content-Type: application/json" \
  -d '{
    "contents": [{
      "role": "user",
      "parts": [{"text": "你好"}]
    }]
  }'
```

## 七、支持的模型列表

### 7.1 基础模型
| 模型名称 | 说明 | 输入Token限制 | 输出Token限制 |
|---------|------|--------------|--------------|
| gemini-2.5-pro | 高级多模态模型 | 1,048,576 | 65,535 |
| gemini-2.5-flash | 快速高效模型 | 1,048,576 | 65,535 |
| gemini-2.5-pro-preview-xxx | Pro预览版本 | 1,048,576 | 65,535 |
| gemini-2.5-flash-preview-xxx | Flash预览版本 | 1,048,576 | 65,535 |

### 7.2 模型变体

#### 搜索增强变体（-search）
- `gemini-2.5-pro-search`
- `gemini-2.5-flash-search`
- 特性：启用Google搜索进行事实核查

#### 推理控制变体
- `-nothinking`: 最小化推理步骤，快速响应
- `-maxthinking`: 最大化推理预算，深度思考

示例：
- `gemini-2.5-pro-nothinking`
- `gemini-2.5-pro-maxthinking`
- `gemini-2.5-flash-search-maxthinking`

## 八、关键技术难点

### 8.1 Google OAuth认证
**难点**: OAuth 2.0流程复杂，需要正确配置凭证  
**解决方案**: 
- 项目已内置OAuth流程
- 支持多种凭证输入方式
- 自动刷新token机制

### 8.2 API格式转换
**难点**: OpenAI和Gemini的API格式差异  
**解决方案**:
- `openai_transformers.py` 实现了格式转换器
- 自动处理消息格式、角色映射
- 流式响应的SSE格式转换

### 8.3 流式响应处理
**难点**: 实时流式数据的处理和转发  
**解决方案**:
- 使用FastAPI的StreamingResponse
- SSE（Server-Sent Events）格式输出
- 思维过程和内容的分离

## 九、常见问题（FAQ）

### Q1: 如何获取Google OAuth凭证？
A: 参考第五章"Google OAuth凭证获取流程"

### Q2: 支持哪些认证方式？
A: Bearer Token、Basic Auth、Query Parameter、Google Header

### Q3: 是否支持图像输入？
A: 是的，支持多模态输入（文本+图像）

### Q4: 如何选择合适的模型？
A: 
- 快速响应：gemini-2.5-flash
- 深度思考：gemini-2.5-pro-maxthinking
- 需要搜索：xxx-search变体

### Q5: 端口占用怎么办？
A: 修改`.env`文件中的`PORT`变量

### Q6: Docker容器无法启动？
A: 检查：
1. 环境变量是否正确配置
2. 凭证JSON格式是否正确
3. 端口是否被占用

## 十、下一步行动计划

### 阶段一：环境准备 ✅
- [x] 克隆项目代码
- [x] 创建文件夹结构
- [x] 编写项目规划文档

### 阶段二：凭证获取
- [ ] 创建Google Cloud项目
- [ ] 启用必要的API
- [ ] 获取OAuth凭证
- [ ] 配置环境变量

### 阶段三：本地部署
- [ ] 创建.env配置文件
- [ ] Docker构建和运行
- [ ] 健康检查验证

### 阶段四：功能测试
- [ ] 测试OpenAI兼容接口
- [ ] 测试原生Gemini接口
- [ ] 测试流式响应
- [ ] 测试不同模型变体

### 阶段五：文档完善
- [ ] 编写详细的使用教程
- [ ] 创建API测试脚本
- [ ] 整理常见问题解答

## 十一、注意事项

### 11.1 安全注意事项
- ⚠️ **凭证安全**: OAuth凭证包含敏感信息，切勿提交到公开仓库
- ⚠️ **密码强度**: `GEMINI_AUTH_PASSWORD`应使用强密码
- ⚠️ **HTTPS**: 生产环境建议使用HTTPS

### 11.2 使用限制
- ⚠️ **API配额**: 受Google免费配额限制
- ⚠️ **并发限制**: 注意API调用频率
- ⚠️ **Token限制**: 注意输入输出Token限制

### 11.3 开发建议
- ✅ 使用Docker部署，保证环境一致性
- ✅ 定期检查凭证有效期
- ✅ 记录API调用日志
- ✅ 实现错误重试机制

---

**文档版本**: 1.0  
**创建时间**: 2025-10-20  
**最后更新**: 2025-10-20

