# geminicli2api æ•…éšœæ’æŸ¥æŒ‡å—

æœ¬æŒ‡å—æ±‡æ€»äº†ä½¿ç”¨ geminicli2api æ—¶å¯èƒ½é‡åˆ°çš„å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆã€‚

## ç›®å½•

- [éƒ¨ç½²é—®é¢˜](#éƒ¨ç½²é—®é¢˜)
- [è®¤è¯é—®é¢˜](#è®¤è¯é—®é¢˜)
- [APIè°ƒç”¨é—®é¢˜](#apiè°ƒç”¨é—®é¢˜)
- [Dockeré—®é¢˜](#dockeré—®é¢˜)
- [ç½‘ç»œé—®é¢˜](#ç½‘ç»œé—®é¢˜)
- [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜)
- [è¯Šæ–­å·¥å…·](#è¯Šæ–­å·¥å…·)

---

## éƒ¨ç½²é—®é¢˜

### é—®é¢˜1ï¼šDockeré•œåƒæ„å»ºå¤±è´¥

**ç—‡çŠ¶**ï¼š
```
ERROR [internal] load metadata for docker.io/library/python:3.11-slim
```

**å¯èƒ½åŸå› **ï¼š
- Docker Hubç½‘ç»œè¿æ¥é—®é¢˜
- Dockeré…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   ping docker.io
   ```

2. **é…ç½®Dockeré•œåƒæºï¼ˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼‰**
   
   ç¼–è¾‘ `C:\Users\<ä½ çš„ç”¨æˆ·å>\.docker\daemon.json`ï¼ˆWindowsï¼‰ï¼š
   ```json
   {
     "registry-mirrors": [
       "https://docker.mirrors.ustc.edu.cn",
       "https://mirror.ccs.tencentyun.com"
     ]
   }
   ```
   
   é‡å¯Docker Desktopã€‚

3. **æ‰‹åŠ¨æ‹‰å–åŸºç¡€é•œåƒ**
   ```bash
   docker pull python:3.11-slim
   ```

### é—®é¢˜2ï¼šç«¯å£å·²è¢«å ç”¨

**ç—‡çŠ¶**ï¼š
```
Error starting userland proxy: listen tcp4 0.0.0.0:8888: bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šæ›´æ¢ç«¯å£**
```bash
# ç¼–è¾‘ .env æ–‡ä»¶
PORT=8889  # æ”¹ä¸ºå…¶ä»–æœªä½¿ç”¨çš„ç«¯å£

# é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d
```

**æ–¹æ¡ˆBï¼šé‡Šæ”¾ç«¯å£**

Windows:
```bash
# 1. æŸ¥æ‰¾å ç”¨è¿›ç¨‹
netstat -ano | findstr :8888

# 2. ç»ˆæ­¢è¿›ç¨‹ï¼ˆæ›¿æ¢<PID>ä¸ºå®é™…è¿›ç¨‹IDï¼‰
taskkill /PID <PID> /F
```

Linux/Mac:
```bash
# æŸ¥æ‰¾å¹¶ç»ˆæ­¢
lsof -ti:8888 | xargs kill -9
```

### é—®é¢˜3ï¼šç¯å¢ƒå˜é‡æœªåŠ è½½

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—æ˜¾ç¤º "No credentials found"
- æœåŠ¡å¯åŠ¨ä½†æ— æ³•å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥ .env æ–‡ä»¶ä½ç½®**
   ```bash
   # ç¡®ä¿ .env åœ¨é¡¹ç›®æ ¹ç›®å½•
   ls -la | findstr .env
   ```

2. **æ£€æŸ¥ .env æ ¼å¼**
   ```env
   # âœ… æ­£ç¡®æ ¼å¼
   GEMINI_AUTH_PASSWORD=your_password
   
   # âŒ é”™è¯¯æ ¼å¼ï¼ˆæœ‰ç©ºæ ¼ï¼‰
   GEMINI_AUTH_PASSWORD = your_password
   ```

3. **æ£€æŸ¥JSONå‡­è¯æ ¼å¼**
   - æ•´ä¸ªJSONå¿…é¡»ç”¨å•å¼•å·åŒ…è£¹
   - JSONå†…éƒ¨ä½¿ç”¨åŒå¼•å·
   - ä¸èƒ½æœ‰æ¢è¡Œï¼ˆå¿…é¡»æ˜¯ä¸€è¡Œï¼‰

4. **é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡**
   ```bash
   docker-compose down
   docker-compose up -d
   ```

---

## è®¤è¯é—®é¢˜

### é—®é¢˜4ï¼š401 Unauthorized

**ç—‡çŠ¶**ï¼š
```json
{"detail":"Invalid authentication credentials"}
```

**å¯èƒ½åŸå› **ï¼š
- å¯†ç é”™è¯¯
- è®¤è¯å¤´æ ¼å¼é”™è¯¯
- OAuthå‡­è¯æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥å¯†ç **
   ```bash
   # æŸ¥çœ‹é…ç½®çš„å¯†ç 
   cat .env | findstr GEMINI_AUTH_PASSWORD
   ```

2. **æ£€æŸ¥è®¤è¯å¤´æ ¼å¼**
   
   âœ… æ­£ç¡®æ ¼å¼ï¼š
   ```bash
   Authorization: Bearer your_password
   ```
   
   âŒ é”™è¯¯æ ¼å¼ï¼š
   ```bash
   Authorization: Bearer: your_password  # å¤šä½™çš„å†’å·
   Authorization: your_password          # ç¼ºå°‘ Bearer
   ```

3. **æµ‹è¯•ä¸åŒè®¤è¯æ–¹å¼**
   
   æ–¹å¼1ï¼šBearer Token
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```
   
   æ–¹å¼2ï¼šQuery Parameter
   ```bash
   curl http://localhost:8888/v1/models?key=your_password
   ```
   
   æ–¹å¼3ï¼šGoogle Header
   ```bash
   curl -H "x-goog-api-key: your_password" http://localhost:8888/v1/models
   ```

### é—®é¢˜5ï¼šOAuthå‡­è¯è¿‡æœŸ

**ç—‡çŠ¶**ï¼š
```
Failed to refresh credentials
Token has expired
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥refresh_tokenæ˜¯å¦å­˜åœ¨**
   ```bash
   # åœ¨ .env ä¸­æ£€æŸ¥å‡­è¯
   cat .env | findstr refresh_token
   ```

2. **æ‰‹åŠ¨åˆ·æ–°token**
   
   é¡¹ç›®ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œå¦‚æœè‡ªåŠ¨åˆ·æ–°å¤±è´¥ï¼š
   - é‡æ–°è¿è¡ŒOAuthæµç¨‹ï¼ˆåˆ é™¤ `oauth_creds.json`ï¼‰
   - æˆ–ä½¿ç”¨OAuth Playgroundé‡æ–°è·å–token

3. **é‡å¯æœåŠ¡è§¦å‘åˆ·æ–°**
   ```bash
   docker-compose restart
   ```

### é—®é¢˜6ï¼šOAuthæµç¨‹æ— æ³•å®Œæˆ

**ç—‡çŠ¶**ï¼š
- æµè§ˆå™¨æ‰“å¼€æˆæƒé¡µé¢åæ— æ³•å›è°ƒ
- æ˜¾ç¤º "redirect_uri_mismatch"

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥OAuthå®¢æˆ·ç«¯é…ç½®**
   - ç™»å½• Google Cloud Console
   - å¯¼èˆªåˆ° "å‡­æ®" â†’ ç¼–è¾‘OAuthå®¢æˆ·ç«¯
   - ç¡®ä¿ "å·²æˆæƒçš„é‡å®šå‘ URI" åŒ…å«ï¼š`http://localhost:8080`

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - æ¸…é™¤Googleè´¦å·ç›¸å…³Cookie
   - ä½¿ç”¨æ— ç—•æ¨¡å¼é‡è¯•

3. **æ£€æŸ¥ç«¯å£8080æ˜¯å¦è¢«å ç”¨**
   ```bash
   netstat -ano | findstr :8080
   ```

---

## APIè°ƒç”¨é—®é¢˜

### é—®é¢˜7ï¼šæ¨¡å‹ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼š
```json
{"error":"Model not found"}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **åˆ—å‡ºå¯ç”¨æ¨¡å‹**
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```

2. **æ£€æŸ¥æ¨¡å‹åç§°**
   
   âœ… æ­£ç¡®ï¼š
   - `gemini-2.5-flash`
   - `gemini-2.5-pro`
   
   âŒ é”™è¯¯ï¼š
   - `models/gemini-2.5-flash` (OpenAIæ¥å£ä¸éœ€è¦ `models/` å‰ç¼€)
   - `gemini-25-flash` (æ‹¼å†™é”™è¯¯)

3. **OpenAI vs Geminiæ¥å£å·®å¼‚**
   
   OpenAIæ¥å£ï¼š
   ```python
   model="gemini-2.5-flash"  # ä¸å¸¦å‰ç¼€
   ```
   
   GeminiåŸç”Ÿæ¥å£ï¼š
   ```python
   url = "/v1beta/models/gemini-2.5-flash:generateContent"  # å®Œæ•´è·¯å¾„
   ```

### é—®é¢˜8ï¼šæµå¼å“åº”ä¸­æ–­

**ç—‡çŠ¶**ï¼š
- æµå¼å“åº”åªæ”¶åˆ°éƒ¨åˆ†å†…å®¹å°±åœæ­¢
- è¿æ¥æ„å¤–å…³é—­

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **å¢åŠ è¶…æ—¶è®¾ç½®**
   ```python
   response = client.chat.completions.create(
       model="gemini-2.5-flash",
       messages=[...],
       stream=True,
       timeout=60  # å¢åŠ è¶…æ—¶æ—¶é—´
   )
   ```

2. **æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§**
   ```bash
   ping localhost -n 100
   ```

3. **å‡å°‘å†…å®¹é•¿åº¦**
   ```python
   response = client.chat.completions.create(
       model="gemini-2.5-flash",
       messages=[...],
       stream=True,
       max_tokens=500  # é™åˆ¶è¾“å‡ºé•¿åº¦
   )
   ```

### é—®é¢˜9ï¼šå“åº”é€Ÿåº¦æ…¢

**ç—‡çŠ¶**ï¼š
- APIå“åº”æ—¶é—´è¶…è¿‡10ç§’
- æµå¼å“åº”å»¶è¿Ÿä¸¥é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹**
   ```python
   # âœ… å¿«é€Ÿï¼ˆæ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
   model="gemini-2.5-flash"
   
   # â±ï¸ è¾ƒæ…¢ï¼ˆå¤æ‚ä»»åŠ¡ï¼‰
   model="gemini-2.5-pro"
   ```

2. **ç¦ç”¨æ€ç»´è¿‡ç¨‹**
   ```python
   # å¦‚æœä¸éœ€è¦æ€ç»´è¿‡ç¨‹ï¼Œä½¿ç”¨nothinkingå˜ä½“
   model="gemini-2.5-flash-nothinking"
   ```

3. **å‡å°‘è¾“å…¥é•¿åº¦**
   - ç²¾ç®€æç¤ºè¯
   - é¿å…ä¼ é€’è¿‡é•¿çš„ä¸Šä¸‹æ–‡

4. **æ£€æŸ¥ç³»ç»Ÿèµ„æº**
   ```bash
   # æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
   docker stats
   ```

---

## Dockeré—®é¢˜

### é—®é¢˜10ï¼šDockerå®¹å™¨é¢‘ç¹é‡å¯

**ç—‡çŠ¶**ï¼š
```bash
docker ps  # æ˜¾ç¤ºå®¹å™¨ä¸æ–­é‡å¯
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æŸ¥çœ‹å®¹å™¨æ—¥å¿—**
   ```bash
   docker-compose logs --tail=100
   ```

2. **æ£€æŸ¥å¸¸è§é”™è¯¯**
   - å‡­è¯æ ¼å¼é”™è¯¯
   - ç«¯å£å†²çª
   - å†…å­˜ä¸è¶³

3. **å¢åŠ å¥åº·æ£€æŸ¥ç­‰å¾…æ—¶é—´**
   
   ç¼–è¾‘ `docker-compose.yml`ï¼š
   ```yaml
   healthcheck:
     start_period: 60s  # å¢åŠ åˆ°60ç§’
   ```

4. **æ£€æŸ¥Dockerèµ„æºåˆ†é…**
   - Docker Desktop â†’ Settings â†’ Resources
   - ç¡®ä¿è‡³å°‘åˆ†é… 2GB å†…å­˜

### é—®é¢˜11ï¼šæ— æ³•è®¿é—®å®¹å™¨æ—¥å¿—

**ç—‡çŠ¶**ï¼š
```
Error: No such container
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **åˆ—å‡ºæ‰€æœ‰å®¹å™¨**
   ```bash
   docker ps -a
   ```

2. **ä½¿ç”¨å®¹å™¨åç§°**
   ```bash
   # æŸ¥æ‰¾æ­£ç¡®çš„å®¹å™¨å
   docker ps | findstr gemini
   
   # ä½¿ç”¨å®Œæ•´åç§°
   docker logs <container_name>
   ```

---

## ç½‘ç»œé—®é¢˜

### é—®é¢˜12ï¼šæ— æ³•è®¿é—®Google API

**ç—‡çŠ¶**ï¼š
```
Connection timeout
Failed to connect to generativelanguage.googleapis.com
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æµ‹è¯•ç½‘ç»œè¿æ¥**
   ```bash
   ping generativelanguage.googleapis.com
   curl https://generativelanguage.googleapis.com
   ```

2. **é…ç½®ä»£ç†ï¼ˆå¦‚éœ€è¦ï¼‰**
   
   ç¼–è¾‘ `docker-compose.yml`ï¼š
   ```yaml
   environment:
     - HTTP_PROXY=http://your-proxy:port
     - HTTPS_PROXY=http://your-proxy:port
   ```

3. **æ£€æŸ¥é˜²ç«å¢™è®¾ç½®**
   - å…è®¸Dockerè®¿é—®å¤–ç½‘
   - æ£€æŸ¥å…¬å¸ç½‘ç»œç­–ç•¥

---

## æ€§èƒ½é—®é¢˜

### é—®é¢˜13ï¼šé«˜å¹¶å‘ä¸‹æœåŠ¡ä¸ç¨³å®š

**ç—‡çŠ¶**ï¼š
- è¯·æ±‚è¶…æ—¶
- 502 Bad Gateway
- å®¹å™¨å´©æºƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **å¢åŠ å®¹å™¨èµ„æºé™åˆ¶**
   
   ç¼–è¾‘ `docker-compose.yml`ï¼š
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '2'
         memory: 4G
   ```

2. **é™åˆ¶å¹¶å‘è¯·æ±‚æ•°**
   
   åœ¨åº”ç”¨å±‚å®ç°è¯·æ±‚é˜Ÿåˆ—ã€‚

3. **ä½¿ç”¨è´Ÿè½½å‡è¡¡**
   - å¯åŠ¨å¤šä¸ªå®¹å™¨å®ä¾‹
   - ä½¿ç”¨Nginxè¿›è¡Œè´Ÿè½½å‡è¡¡

---

## è¯Šæ–­å·¥å…·

### ä½¿ç”¨å¥åº·æ£€æŸ¥è„šæœ¬

```bash
cd src
python health_check.py
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… æœåŠ¡å¥åº·çŠ¶æ€
- âœ… APIç«¯ç‚¹å¯ç”¨æ€§
- âœ… è®¤è¯åŠŸèƒ½
- âœ… Dockerå®¹å™¨çŠ¶æ€

### æ‰‹åŠ¨è¯Šæ–­æ­¥éª¤

1. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
   ```bash
   docker-compose ps
   ```

2. **æŸ¥çœ‹å®æ—¶æ—¥å¿—**
   ```bash
   docker-compose logs -f
   ```

3. **æµ‹è¯•å¥åº·ç«¯ç‚¹**
   ```bash
   curl http://localhost:8888/health
   ```

4. **æµ‹è¯•æ ¹ç«¯ç‚¹**
   ```bash
   curl http://localhost:8888/
   ```

5. **æµ‹è¯•è®¤è¯**
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```

### æ”¶é›†è¯Šæ–­ä¿¡æ¯

å¦‚éœ€æŠ¥å‘Šé—®é¢˜ï¼Œè¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **ç³»ç»Ÿä¿¡æ¯**
   ```bash
   docker --version
   docker-compose --version
   ```

2. **å®¹å™¨çŠ¶æ€**
   ```bash
   docker ps -a > container_status.txt
   ```

3. **å®¹å™¨æ—¥å¿—**
   ```bash
   docker-compose logs > service_logs.txt
   ```

4. **ç¯å¢ƒå˜é‡ï¼ˆè„±æ•ï¼‰**
   ```bash
   # ä»…åŒ…å«å˜é‡åï¼Œä¸åŒ…å«å€¼
   cat .env | findstr "=" > env_keys.txt
   ```

---

## å¿«é€Ÿè¯Šæ–­æ¸…å•

å½“é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

- [ ] Dockeræ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ
- [ ] å®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Ÿï¼ˆ`docker-compose ps`ï¼‰
- [ ] å¥åº·æ£€æŸ¥æ˜¯å¦é€šè¿‡ï¼Ÿï¼ˆ`curl http://localhost:8888/health`ï¼‰
- [ ] `.env` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼Ÿ
- [ ] OAuthå‡­è¯æ˜¯å¦æœ‰æ•ˆï¼Ÿ
- [ ] ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Ÿ
- [ ] ç½‘ç»œæ˜¯å¦æ­£å¸¸ï¼Ÿï¼ˆèƒ½å¦è®¿é—®Google APIï¼‰
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰æ˜æ˜¾é”™è¯¯ï¼Ÿï¼ˆ`docker-compose logs`ï¼‰

---

## è·å–æ›´å¤šå¸®åŠ©

å¦‚æœæœ¬æŒ‡å—æœªèƒ½è§£å†³æ‚¨çš„é—®é¢˜ï¼š

1. ğŸ“˜ æŸ¥çœ‹ [é¡¹ç›®è§„åˆ’æ–‡æ¡£](é¡¹ç›®è§„åˆ’.md)
2. ğŸ“˜ æŸ¥çœ‹ [OAuthæ•™ç¨‹](Google_OAuthå‡­è¯è·å–æ•™ç¨‹.md)
3. ğŸ” æœç´¢åŸé¡¹ç›® Issuesï¼šhttps://github.com/gzzhongqi/geminicli2api/issues
4. ğŸ’¬ åœ¨åŸé¡¹ç›®åˆ›å»ºæ–°çš„Issueï¼ˆé™„ä¸Šè¯Šæ–­ä¿¡æ¯ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-20  
**æœ€åæ›´æ–°**: 2025-10-20

å¸Œæœ›æœ¬æŒ‡å—èƒ½å¸®åŠ©æ‚¨å¿«é€Ÿè§£å†³é—®é¢˜ï¼ğŸ”§

