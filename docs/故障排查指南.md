# geminicli2api 故障排查指南

本指南汇总了使用 geminicli2api 时可能遇到的常见问题及解决方案。

## 目录

- [部署问题](#部署问题)
- [认证问题](#认证问题)
- [API调用问题](#api调用问题)
- [Docker问题](#docker问题)
- [网络问题](#网络问题)
- [性能问题](#性能问题)
- [诊断工具](#诊断工具)

---

## 部署问题

### 问题1：Docker镜像构建失败

**症状**：
```
ERROR [internal] load metadata for docker.io/library/python:3.11-slim
```

**可能原因**：
- Docker Hub网络连接问题
- Docker配置错误

**解决方案**：

1. **检查网络连接**
   ```bash
   ping docker.io
   ```

2. **配置Docker镜像源（中国大陆用户）**
   
   编辑 `C:\Users\<你的用户名>\.docker\daemon.json`（Windows）：
   ```json
   {
     "registry-mirrors": [
       "https://docker.mirrors.ustc.edu.cn",
       "https://mirror.ccs.tencentyun.com"
     ]
   }
   ```
   
   重启Docker Desktop。

3. **手动拉取基础镜像**
   ```bash
   docker pull python:3.11-slim
   ```

### 问题2：端口已被占用

**症状**：
```
Error starting userland proxy: listen tcp4 0.0.0.0:8888: bind: address already in use
```

**解决方案**：

**方案A：更换端口**
```bash
# 编辑 .env 文件
PORT=8889  # 改为其他未使用的端口

# 重启服务
docker-compose down
docker-compose up -d
```

**方案B：释放端口**

Windows:
```bash
# 1. 查找占用进程
netstat -ano | findstr :8888

# 2. 终止进程（替换<PID>为实际进程ID）
taskkill /PID <PID> /F
```

Linux/Mac:
```bash
# 查找并终止
lsof -ti:8888 | xargs kill -9
```

### 问题3：环境变量未加载

**症状**：
- 日志显示 "No credentials found"
- 服务启动但无法工作

**解决方案**：

1. **检查 .env 文件位置**
   ```bash
   # 确保 .env 在项目根目录
   ls -la | findstr .env
   ```

2. **检查 .env 格式**
   ```env
   # ✅ 正确格式
   GEMINI_AUTH_PASSWORD=your_password
   
   # ❌ 错误格式（有空格）
   GEMINI_AUTH_PASSWORD = your_password
   ```

3. **检查JSON凭证格式**
   - 整个JSON必须用单引号包裹
   - JSON内部使用双引号
   - 不能有换行（必须是一行）

4. **重新加载环境变量**
   ```bash
   docker-compose down
   docker-compose up -d
   ```

---

## 认证问题

### 问题4：401 Unauthorized

**症状**：
```json
{"detail":"Invalid authentication credentials"}
```

**可能原因**：
- 密码错误
- 认证头格式错误
- OAuth凭证无效

**解决方案**：

1. **检查密码**
   ```bash
   # 查看配置的密码
   cat .env | findstr GEMINI_AUTH_PASSWORD
   ```

2. **检查认证头格式**
   
   ✅ 正确格式：
   ```bash
   Authorization: Bearer your_password
   ```
   
   ❌ 错误格式：
   ```bash
   Authorization: Bearer: your_password  # 多余的冒号
   Authorization: your_password          # 缺少 Bearer
   ```

3. **测试不同认证方式**
   
   方式1：Bearer Token
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```
   
   方式2：Query Parameter
   ```bash
   curl http://localhost:8888/v1/models?key=your_password
   ```
   
   方式3：Google Header
   ```bash
   curl -H "x-goog-api-key: your_password" http://localhost:8888/v1/models
   ```

### 问题5：OAuth凭证过期

**症状**：
```
Failed to refresh credentials
Token has expired
```

**解决方案**：

1. **检查refresh_token是否存在**
   ```bash
   # 在 .env 中检查凭证
   cat .env | findstr refresh_token
   ```

2. **手动刷新token**
   
   项目会自动刷新，如果自动刷新失败：
   - 重新运行OAuth流程（删除 `oauth_creds.json`）
   - 或使用OAuth Playground重新获取token

3. **重启服务触发刷新**
   ```bash
   docker-compose restart
   ```

### 问题6：OAuth流程无法完成

**症状**：
- 浏览器打开授权页面后无法回调
- 显示 "redirect_uri_mismatch"

**解决方案**：

1. **检查OAuth客户端配置**
   - 登录 Google Cloud Console
   - 导航到 "凭据" → 编辑OAuth客户端
   - 确保 "已授权的重定向 URI" 包含：`http://localhost:8080`

2. **清除浏览器缓存**
   - 清除Google账号相关Cookie
   - 使用无痕模式重试

3. **检查端口8080是否被占用**
   ```bash
   netstat -ano | findstr :8080
   ```

---

## API调用问题

### 问题7：模型不存在

**症状**：
```json
{"error":"Model not found"}
```

**解决方案**：

1. **列出可用模型**
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```

2. **检查模型名称**
   
   ✅ 正确：
   - `gemini-2.5-flash`
   - `gemini-2.5-pro`
   
   ❌ 错误：
   - `models/gemini-2.5-flash` (OpenAI接口不需要 `models/` 前缀)
   - `gemini-25-flash` (拼写错误)

3. **OpenAI vs Gemini接口差异**
   
   OpenAI接口：
   ```python
   model="gemini-2.5-flash"  # 不带前缀
   ```
   
   Gemini原生接口：
   ```python
   url = "/v1beta/models/gemini-2.5-flash:generateContent"  # 完整路径
   ```

### 问题8：流式响应中断

**症状**：
- 流式响应只收到部分内容就停止
- 连接意外关闭

**解决方案**：

1. **增加超时设置**
   ```python
   response = client.chat.completions.create(
       model="gemini-2.5-flash",
       messages=[...],
       stream=True,
       timeout=60  # 增加超时时间
   )
   ```

2. **检查网络稳定性**
   ```bash
   ping localhost -n 100
   ```

3. **减少内容长度**
   ```python
   response = client.chat.completions.create(
       model="gemini-2.5-flash",
       messages=[...],
       stream=True,
       max_tokens=500  # 限制输出长度
   )
   ```

### 问题9：响应速度慢

**症状**：
- API响应时间超过10秒
- 流式响应延迟严重

**解决方案**：

1. **使用更快的模型**
   ```python
   # ✅ 快速（推荐日常使用）
   model="gemini-2.5-flash"
   
   # ⏱️ 较慢（复杂任务）
   model="gemini-2.5-pro"
   ```

2. **禁用思维过程**
   ```python
   # 如果不需要思维过程，使用nothinking变体
   model="gemini-2.5-flash-nothinking"
   ```

3. **减少输入长度**
   - 精简提示词
   - 避免传递过长的上下文

4. **检查系统资源**
   ```bash
   # 查看容器资源使用
   docker stats
   ```

---

## Docker问题

### 问题10：Docker容器频繁重启

**症状**：
```bash
docker ps  # 显示容器不断重启
```

**解决方案**：

1. **查看容器日志**
   ```bash
   docker-compose logs --tail=100
   ```

2. **检查常见错误**
   - 凭证格式错误
   - 端口冲突
   - 内存不足

3. **增加健康检查等待时间**
   
   编辑 `docker-compose.yml`：
   ```yaml
   healthcheck:
     start_period: 60s  # 增加到60秒
   ```

4. **检查Docker资源分配**
   - Docker Desktop → Settings → Resources
   - 确保至少分配 2GB 内存

### 问题11：无法访问容器日志

**症状**：
```
Error: No such container
```

**解决方案**：

1. **列出所有容器**
   ```bash
   docker ps -a
   ```

2. **使用容器名称**
   ```bash
   # 查找正确的容器名
   docker ps | findstr gemini
   
   # 使用完整名称
   docker logs <container_name>
   ```

---

## 网络问题

### 问题12：无法访问Google API

**症状**：
```
Connection timeout
Failed to connect to generativelanguage.googleapis.com
```

**解决方案**：

1. **测试网络连接**
   ```bash
   ping generativelanguage.googleapis.com
   curl https://generativelanguage.googleapis.com
   ```

2. **配置代理（如需要）**
   
   编辑 `docker-compose.yml`：
   ```yaml
   environment:
     - HTTP_PROXY=http://your-proxy:port
     - HTTPS_PROXY=http://your-proxy:port
   ```

3. **检查防火墙设置**
   - 允许Docker访问外网
   - 检查公司网络策略

---

## 性能问题

### 问题13：高并发下服务不稳定

**症状**：
- 请求超时
- 502 Bad Gateway
- 容器崩溃

**解决方案**：

1. **增加容器资源限制**
   
   编辑 `docker-compose.yml`：
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '2'
         memory: 4G
   ```

2. **限制并发请求数**
   
   在应用层实现请求队列。

3. **使用负载均衡**
   - 启动多个容器实例
   - 使用Nginx进行负载均衡

---

## 诊断工具

### 使用健康检查脚本

```bash
cd src
python health_check.py
```

该脚本会自动检查：
- ✅ 服务健康状态
- ✅ API端点可用性
- ✅ 认证功能
- ✅ Docker容器状态

### 手动诊断步骤

1. **检查服务状态**
   ```bash
   docker-compose ps
   ```

2. **查看实时日志**
   ```bash
   docker-compose logs -f
   ```

3. **测试健康端点**
   ```bash
   curl http://localhost:8888/health
   ```

4. **测试根端点**
   ```bash
   curl http://localhost:8888/
   ```

5. **测试认证**
   ```bash
   curl -H "Authorization: Bearer your_password" http://localhost:8888/v1/models
   ```

### 收集诊断信息

如需报告问题，请收集以下信息：

1. **系统信息**
   ```bash
   docker --version
   docker-compose --version
   ```

2. **容器状态**
   ```bash
   docker ps -a > container_status.txt
   ```

3. **容器日志**
   ```bash
   docker-compose logs > service_logs.txt
   ```

4. **环境变量（脱敏）**
   ```bash
   # 仅包含变量名，不包含值
   cat .env | findstr "=" > env_keys.txt
   ```

---

## 快速诊断清单

当遇到问题时，按以下顺序检查：

- [ ] Docker是否正在运行？
- [ ] 容器是否启动成功？（`docker-compose ps`）
- [ ] 健康检查是否通过？（`curl http://localhost:8888/health`）
- [ ] `.env` 文件是否存在且格式正确？
- [ ] OAuth凭证是否有效？
- [ ] 端口是否被占用？
- [ ] 网络是否正常？（能否访问Google API）
- [ ] 日志中是否有明显错误？（`docker-compose logs`）

---

## 获取更多帮助

如果本指南未能解决您的问题：

1. 📘 查看 [项目规划文档](项目规划.md)
2. 📘 查看 [OAuth教程](Google_OAuth凭证获取教程.md)
3. 🔍 搜索原项目 Issues：https://github.com/gzzhongqi/geminicli2api/issues
4. 💬 在原项目创建新的Issue（附上诊断信息）

---

**文档版本**: 1.0  
**创建时间**: 2025-10-20  
**最后更新**: 2025-10-20

希望本指南能帮助您快速解决问题！🔧

